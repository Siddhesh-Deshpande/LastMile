- name: Deploy to Minikube
  hosts: kubehosts
  vars:
    deployments_dir: "../deployment"
    minikube_driver: "docker"
    minikube_cpu: "6"
    minikube_memory: "8gb"

  tasks:
    - name: Check if Minikube is already running
      shell: "minikube status --format '{{'{{.Host}}'}}'"
      register: minikube_status
      ignore_errors: true

    - name: Start Minikube
      shell: minikube start --driver={{ minikube_driver }} --cpus={{ minikube_cpu }} --memory={{ minikube_memory }}
      when: minikube_status.stdout != "Running"
    
    - name: enable ingress in minikube
      shell: minikube addons enable ingress

    - name: Wait for ingress-nginx controller to be ready
      shell: |
        kubectl wait --namespace ingress-nginx \
          --for=condition=Available deployment/ingress-nginx-controller \
          --timeout=120s
      register: ingress_ready
      until: ingress_ready.rc == 0
      retries: 5
      delay: 5
    - name: Wait for ingress admission patch job
      shell: |
        kubectl wait --namespace ingress-nginx \
          --for=condition=Complete job/ingress-nginx-admission-patch \
          --timeout=120s || true
    - name: deploy using kubectl
      shell: kubectl apply -R -f {{ deployments_dir }}

